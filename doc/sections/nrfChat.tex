\section{Communicatie}

In dit hoofdstuk wordt ingegaan op hoe de ISO die in het vak sensor netwerken gemaakt is, is geÃ¯mplementeerd door team 2. De implementatie is in twee delen opgesplitst: iso en vriendjes lijst. Iso wordt gebruikt om de nrf24l01p aan te sturen terwijl de vriendjes lijst is een erg eenvoudige database voor in een microcontroller is.
\subsection{ISO}
    \input{sections/iso.tex}
    
\subsection{Vriendjes}
    In friendList.h en friendList.c worden alle vriendjes (nodes) van het netwerk opgeslagen. 
    \subsubsection{Datastructuur}
        Vriendjes hebben een aantal eigenschappen die onthouden moeten worden om er voor te zorgen dat iso goed kan werken. Een van deze eigenschappen is het unieke ID van een vriendje, hoeveel vriendjes tussen jou en het vriendje in zitten, via wie dit vriendje te bereiken is, hoeveel vertrouwen we hebben in het vriendje en of we het vriendje actief vertrouwen. Omdat deze verschillende elementen vaak nodig zijn is er voor gekozen om deze elementen in een struct samen te voegen en voor programmeer gemak een typedef van deze struct te maken (zie \autoref{lst:friendType}). 
\begin{lstlisting}[caption={Vriendjes struct},captionpos=b,label={lst:friendType},style=c]
typedef struct {
    uint8_t id;
    uint8_t hops;
    uint8_t via;
    uint8_t trust;
    uint8_t active;
}friend_t;
\end{lstlisting}

        Tijdens de initialisatie wordt er een array van 8 friend\_t elementen gealloceerd waar alle id's van de array op 0x00 worden gezet. Deze array is alleen vanuit het friendsList.c bestand te bereiken.

    \subsubsection{Vriendjes toevoegen}
        Om een vriendje toe te voegen wordt de updateFriend functie gebruikt. Deze functie heeft het id, aantal hops en de via data van het nieuwe vriendje nodig. Het id wordt gebruikt om te kijken of het vriendje al bekend is, als het vriendje al bekend is en een directe verbinding heeft (hops = 0) worden de volgende stappen uitgevoerd (zie \autoref{lst:updateDirectFriend}):
        \begin{itemize}
            \item Hoog trust op met TRUST\_ADDER
            \item Als de trust groter is dan MAX\_TRUST zet trust op MAX\_TRUST
            \item Als de trust hoog genoeg is maak het vriendje actief
        \end{itemize}
\begin{lstlisting}[caption={Update direct vriendje},captionpos=b,label={lst:updateDirectFriend},style=c,xleftmargin=.\textwidth,xrightmargin=.\textwidth]
// If it's a direct connection:
if(hops == 0) {
    oldFriend->trust += TRUST_ADDER;

    // Make sure the friend doesn't get too trusted (we have trustissues).
    if(oldFriend->trust > MAX_TRUST) oldFriend->trust = MAX_TRUST;

    // Activate the friend when we trust it enough.
    if(oldFriend->trust > ACTIVATE_TRUST) oldFriend->active = 1;

    DEBUG_PRINTF("\tIt's direct. Increased trust: %2d\tActive: %1d\[0m", \ 
        oldFriend->trust, oldFriend->active);
}
\end{lstlisting}
        Als het vriendje wel bekend is maar niet een direct vriendje is wordt er gekeken of het bestaande vriendje meer hops heeft dan dit nieuwe vriendje. Als dit het geval is worden de via en hops van het oude vriendje vervangen met de via en hops van het nieuwe vriendje (zie \autoref{lst:updateIndirectFriend}). 
\begin{lstlisting}[caption={Update indirect vriendje},captionpos=b,label={lst:updateIndirectFriend},style=c,xleftmargin=.\textwidth,xrightmargin=.\textwidth]
if(hops < oldFriend->hops || oldFriend->hops == 0) {
    oldFriend->via = via;
    oldFriend->hops = hops;
    DEBUG_PRINT("\tNot direct. Replacing hops and via.\e[0m\n");
}
\end{lstlisting}
        In het geval geen van de situaties die hierboven zijn beschreven het geval zijn zal het nieuwe vriendje niet worden meegenomen.
    \subsubsection{Vriendjes verwijderen}
    \subsubsection{Vind vriendje}
    \subsubsection{Vriendjes lijst} \label{ch:printFriends}

\section{Base station}
    \subsection{Functionele blokken}
\section{Debug chat terminal}

Het NrfChat programma laat mensen met elkaar praten via een CLI interface. Om het programma in te stellen kunnen een aantal commando's

\subsection{Commands}
De commando's die in het nrfChat programma kunnen worden gebruikt.

\begin{table}[h]
    \begin{tabular}{|l|l|} \hline
        \textbf{Commando} & \textbf{Beschrijving} \\\hline
        help & Laat een hulp bericht zien \\\hline
        chan & Selecteer het kanaal waarop wordt gezonden en ontvangen\\\hline
        send & Stuur een bericht \\\hline
        list & Laat de vriendjes lijst zien\\\hline
        dest & Stel doel ID in voor berichten die met send worden verstuurd \\\hline
        myid & Laat zien wat het ID is van de node \\\hline
    \end{tabular}
\end{table}

\subsection{Functionele blokken}

\subsection{nrfChat}
    \input{sections/chat.tex}

\subsection{Terminal}
    \input{sections/terminal.tex}
    

    